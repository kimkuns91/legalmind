# LegalMind S3 버킷 구조 및 문서 템플릿 관리

## S3 버킷 폴더 구조

```
legalmind-documents/
├── templates/                  # 문서 템플릿 저장 폴더
│   ├── lease/                  # 임대차 계약서 템플릿
│   │   ├── template.json       # 템플릿 메타데이터 및 구조
│   │   ├── template.html       # HTML 형식 템플릿 (선택사항)
│   │   └── sample.pdf          # 샘플 PDF (참조용)
│   ├── agreement/              # 합의서 템플릿
│   │   ├── template.json
│   │   └── ...
│   └── power-of-attorney/      # 위임장 템플릿
│       ├── template.json
│       └── ...
│
├── generated/                  # 생성된 문서 저장 폴더
│   ├── [YYYY-MM]/              # 연월별 폴더로 구분
│   │   └── [documentType]_[timestamp].pdf
│   └── ...
│
└── assets/                     # 공통 자산 (로고, 서명 이미지 등)
    ├── logo.png
    ├── watermark.png
    └── ...
```

## 폴더 구조 설명

1. **templates/**: 모든 문서 템플릿을 저장하는 최상위 폴더

   - 각 문서 유형별로 하위 폴더 생성
   - 각 템플릿 폴더에는 JSON 형식의 템플릿 정의 파일 포함

2. **generated/**: 생성된 문서를 저장하는 폴더

   - 연월별로 하위 폴더를 생성하여 관리 (예: 2023-06/)
   - 파일명은 `[documentType]_[timestamp].pdf` 형식으로 저장

3. **assets/**: 모든 템플릿에서 공통으로 사용하는 자산 파일 저장

## template.json 구조 예시

```json
{
  "id": "lease",
  "name": "임대차 계약서",
  "version": "1.0",
  "description": "주택 임대차 계약을 위한 표준 계약서",
  "requiredFields": [
    {
      "id": "lessor",
      "name": "임대인",
      "type": "text",
      "required": true
    },
    {
      "id": "lessee",
      "name": "임차인",
      "type": "text",
      "required": true
    },
    {
      "id": "address",
      "name": "주소",
      "type": "text",
      "required": true
    },
    {
      "id": "deposit",
      "name": "보증금",
      "type": "currency",
      "required": true
    },
    {
      "id": "monthlyRent",
      "name": "월세",
      "type": "currency",
      "required": true
    },
    {
      "id": "leaseTerm",
      "name": "계약기간",
      "type": "text",
      "required": true
    }
  ],
  "sections": [
    {
      "title": "계약 당사자",
      "content": "임대인: {{lessor}}\n임차인: {{lessee}}"
    },
    {
      "title": "임대 목적물",
      "content": "주소: {{address}}"
    },
    {
      "title": "계약 조건",
      "content": "보증금: {{deposit}}\n월세: {{monthlyRent}}\n계약기간: {{leaseTerm}}"
    },
    {
      "title": "계약 일반 사항",
      "content": "1. 임차인은 임대인의 동의 없이 임대 목적물을 전대하거나 양도할 수 없다.\n2. 임차인은 임대 목적물을 선량한 관리자의 주의로 사용해야 한다.\n3. 계약 만료 시 임차인은 임대 목적물을 원상복구하여 반환해야 한다."
    }
  ]
}
```

## 구현 방법

### 1. 템플릿 로딩 함수

```typescript
// src/actions/document.ts
async function getDocumentTemplate(documentType: string) {
  try {
    // S3에서 템플릿 JSON 파일 가져오기
    const command = new GetObjectCommand({
      Bucket: AWS_BUCKET_NAME,
      Key: `templates/${documentType}/template.json`,
    });

    const response = await s3Client.send(command);
    const templateJson = await response.Body?.transformToString();

    if (!templateJson) {
      throw new Error(`템플릿을 찾을 수 없습니다: ${documentType}`);
    }

    return JSON.parse(templateJson);
  } catch (error) {
    console.error(`템플릿 로딩 중 오류 (${documentType}):`, error);

    // 로컬 폴백 템플릿 사용 (선택사항)
    return getFallbackTemplate(documentType);
  }
}
```

### 2. 생성된 문서 저장 함수

```typescript
async function generateDocumentFile(filledTemplate: any, documentType: string) {
  try {
    // PDF 생성 로직...

    // 현재 연월 폴더 경로 생성
    const now = new Date();
    const yearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    const fileName = `${documentType}_${Date.now()}.pdf`;
    const key = `generated/${yearMonth}/${fileName}`;

    // S3에 업로드
    await s3Client.send(
      new PutObjectCommand({
        Bucket: AWS_BUCKET_NAME,
        Key: key,
        Body: pdfBytes,
        ContentType: 'application/pdf',
      })
    );

    // 서명된 URL 생성
    const url = await getSignedUrl(
      s3Client,
      new GetObjectCommand({
        Bucket: AWS_BUCKET_NAME,
        Key: key,
      }),
      { expiresIn: 86400 } // 24시간
    );

    return url;
  } catch (error) {
    console.error('문서 파일 생성 중 오류:', error);
    throw error;
  }
}
```

## 초기 템플릿 업로드 방법

### AWS CLI 사용

```bash
# AWS CLI 사용 예시
aws s3 cp templates/lease/template.json s3://legalmind-documents/templates/lease/template.json
```

### 업로드 스크립트 작성

```typescript
// scripts/upload-templates.ts
import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';
import fs from 'fs';
import path from 'path';

const s3Client = new S3Client({
  region: 'ap-northeast-2',
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID || '',
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY || '',
  },
});

async function uploadTemplate(templatePath: string, documentType: string) {
  const templateContent = fs.readFileSync(templatePath, 'utf8');

  await s3Client.send(
    new PutObjectCommand({
      Bucket: 'legalmind-documents',
      Key: `templates/${documentType}/template.json`,
      Body: templateContent,
      ContentType: 'application/json',
    })
  );

  console.log(`템플릿 업로드 완료: ${documentType}`);
}

// 템플릿 업로드 실행
async function main() {
  await uploadTemplate('./templates/lease.json', 'lease');
  await uploadTemplate('./templates/agreement.json', 'agreement');
  await uploadTemplate('./templates/power-of-attorney.json', 'power-of-attorney');
}

main().catch(console.error);
```

## 참고사항

- S3 버킷의 버전 관리 기능을 활성화하면 템플릿 변경 이력을 관리할 수 있습니다.
- CORS 설정을 통해 웹 애플리케이션에서 직접 S3 파일에 접근할 수 있도록 구성할 수 있습니다.
- 보안을 위해 생성된 문서는 서명된 URL을 통해서만 접근 가능하도록 설정하는 것이 좋습니다.
